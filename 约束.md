

# 概述

## 什么是约束

约束是应用于数据库表中数据的强制性规则，用于保证数据的完整性(Integrity)​和准确性。它们限制了可以存储在表中的数据类型，是数据库设计的重要组成部分。

约束是表级强制规定，可以在创建表时规定约束 ( `CREATE TABLE` 语句 ) ，或者在创建表后通过 `ALTER TABLE` 语句规定约束;


根据约束数据列的限制，约束可分为:

1. 单列约束: 每个约束只约束一列;
2. 多列约束: 每个约束可以约束多列;

根据约束的作用范围，约束可分为:

1. 列级约束: 只能作用在一个列上，跟在列的定义后面;
2. 表级约束: 可以作用在多个列上，不与列一起，而是单独定义;

根据约束的作用，约束可以分为:

1. `NOT NULL` 非空约束，规定某个字段不能为空；
2. `UNIQUE` 唯一约束，规定某个字段在整个表中是唯一的;
3. `PRIMARY KEY` 主键约束 ( 非空且唯一 );
4. `FOREIGN KEY` 外键约束;
5. `CHECK` 检查约束; (mysql 不支持 check 约束， 使用 check 约束在mysql中不生效)
6. `DEFAULT` 默认值约束;


## 非空约束 `NOT NULL`

- mysql 默认所有类型的值都可以是 `NULL`，包括 `INT`、`FLOAT`等类型;
- 非空约束只能出现在表对象的列上，只能某个列单独限定非空，不能组合非空;
- 一个表可以配置多个列限定非空;
- 空字符串 `''` 不等于 `NULL`， `0` 也不能与 `NULL`;


### 添加非空约束

> 创建表时

```sql
create table 表名 (
    字段名1 字段类型,
    字段名2 字段类型 NOT NULL,
    字段名3 字段类型 NOT NULL
)
```

> 建表后

```sql
alter table 表名 modify column 字段名 字段类型 not null；
```

> 删除非空约束

```sql
alter table 表名 modify column 字段名 字段类型 null;

或

alter table 表名 modify column 字段名 字段类型;
```

## 唯一约束 `UNIQUE`

唯一约束用来限制某个字段/某列的值不能重复;

- 同一个表可以有多个唯一约束;
- 唯一约束可以是某一列的值唯一，也可以是多个列组合的值唯一;
- 唯一性约束允许值为空;
- 在创建唯一约束的时候，如果不给唯一约束命名，就默认和列名相同；
- mysql 会给唯一约束的列上默认创建一个唯一索引;


### 添加唯一约束

> 创建表时

```sql
# mysql 中 unique 和 unique key 的作用相同
create table 表名 (
    字段名1 数据类型,
    字段名2 数据类型 unique,
    字段名3 数据类型 unique key,
    字段名4 数据类型
)

create table 表名 (
    字段名1 数据类型,
    字段名2 数据类型,
    字段名3 数据类型

    [constraint 约束名] unique key(字段名1)
)

create table 表名 (
    字段名1 数据类型,
    字段名2 数据类型,
    字段名3 数据类型

    [constraint 约束名] unique key(字段名1， 字段名2)   # 符合唯一约束，要求多个列组合值唯一
)
```

案例1： 创建表时，添加约束

```sql
create table if not exists student(sid int, sname varchar(20), tel char(11) unique, cardid char(18) unique key);

desc student;
+--------+-------------+------+-----+---------+-------+
| Field  | Type        | Null | Key | Default | Extra |
+--------+-------------+------+-----+---------+-------+
| sid    | int         | YES  |     | NULL    |       |
| sname  | varchar(20) | YES  |     | NULL    |       |
| tel    | char(11)    | YES  | UNI | NULL    |       |
| cardid | char(18)    | YES  | UNI | NULL    |       |
+--------+-------------+------+-----+---------+-------+
4 rows in set (0.00 sec)

insert into student values(1, 'zhangsan', '13112345678', '112233445566778899');
insert into student values(2, 'lisi', '15212345678', '223344556677889900');

select * from student;
+------+----------+-------------+--------------------+
| sid  | sname    | tel         | cardid             |
+------+----------+-------------+--------------------+
|    1 | zhangsan | 13112345678 | 112233445566778899 |
|    2 | lisi     | 15212345678 | 223344556677889900 |
+------+----------+-------------+--------------------+
2 rows in set (0.00 sec)


# 唯一约束的列数据重复时，插入数据失败
insert into student values(3, 'abc', '13112345678', '123456789123456789');
# ERROR 1062 (23000): Duplicate entry '13112345678' for key 'student.tel'
```


案例2：创建表后添加唯一约束

```sql
# 建表时创建了符合约束 uk_name_pwd
create table if not exists user2(id int not null, name varchar(25), password varchar(16), constraint uk_name_pwd unique key(name, password));

desc user2;
+----------+-------------+------+-----+---------+-------+
| Field    | Type        | Null | Key | Default | Extra |
+----------+-------------+------+-----+---------+-------+
| id       | int         | NO   |     | NULL    |       |
| name     | varchar(25) | YES  | MUL | NULL    |       |
| password | varchar(16) | YES  |     | NULL    |       |
+----------+-------------+------+-----+---------+-------+
3 rows in set (0.00 sec)

show create table user2;
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                            |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| user2 | CREATE TABLE `user2` (
  `id` int NOT NULL,
  `name` varchar(25) DEFAULT NULL,
  `password` varchar(16) DEFAULT NULL,
  UNIQUE KEY `uk_name_pwd` (`name`,`password`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)


alter table user2 modify id int unique key not null;

show create table user2;
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                      |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| user2 | CREATE TABLE `user2` (
  `id` int NOT NULL,
  `name` varchar(25) DEFAULT NULL,
  `password` varchar(16) DEFAULT NULL,
  UNIQUE KEY `id` (`id`),
  UNIQUE KEY `uk_name_pwd` (`name`,`password`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```

案例3：复合约束

```sql

insert into user2 
values
(1, 'zhangsan', '123456'),
(2, 'lisi', '123456');

select * from user2;
+----+----------+----------+
| id | name     | password |
+----+----------+----------+
|  2 | lisi     | 123456   |
|  1 | zhangsan | 123456   |
+----+----------+----------+
2 rows in set (0.00 sec)

# 复合约束时，某个字段的值重复不影响数据插入，如果是所有复合字段的值都相同，也就是复合字段的组合重复时，插入数据失败
insert into user2 values(3, 'zhangsan', '123456');
ERROR 1062 (23000): Duplicate entry 'zhangsan-123456' for key 'user2.uk_name_pwd'
```

### 删除唯一约束

- 添加唯一约束的列也会自动创建唯一索引；
- 删除唯一约束只能通过删除唯一索引的方式删除；
- 删除时需要指定唯一索引名，唯一索引名就和唯一约束名一样；
- 如果创建唯一约束时未指定名称
  - 如果是单列，约束名称和列名相同；
  - 如果是组合列，那么默认和 `()` 中排在第一个的列名相同；
  - 也可以自定义唯一约束名称；

删除唯一约束的语法:

```sql
alter table 表名 drop index 约束名称;
```

```sql
select * from user2;
+----+----------+----------+
| id | name     | password |
+----+----------+----------+
|  2 | lisi     | 123456   |
|  1 | zhangsan | 123456   |
+----+----------+----------+
2 rows in set (0.00 sec)

# 插入失败，id 字段有唯一约束
insert into user2 values (1, 'wangwu', '123321');
# ERROR 1062 (23000): Duplicate entry '1' for key 'user2.id'

# 删除 id 字段的约束
alter table user2 drop index id;

show create table user2;
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                            |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| user2 | CREATE TABLE `user2` (
  `id` int NOT NULL,
  `name` varchar(25) DEFAULT NULL,
  `password` varchar(16) DEFAULT NULL,
  UNIQUE KEY `uk_name_pwd` (`name`,`password`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

# 插入数据
insert into user2 values (1, 'wangwu', '123321');

select * from user2;
+----+----------+----------+
| id | name     | password |
+----+----------+----------+
|  1 | zhangsan | 123456   |
|  2 | lisi     | 123456   |
|  1 | wangwu   | 123321   |
+----+----------+----------+
3 rows in set (0.00 sec)
```

# `PRIMARY KEY` 约束

用来唯一标识表中的一行记录。

- `PRIMARY KEY` 主键约束相当于 `UNIQUE` 唯一约束 + `NOT NULL` 非空约束的组合，主键约束不允许出现重复值，也不允许出现空值；
- 一个表最多只能有一个主键约束；
- 建立主键约束可以在列级别创建，也可以在表级别上创建；
- 主键约束对应着表中的 一列 或者 多个列(复合主键)；
- 如果是多个列组合的复合主键约束，那么这些列都不允许为空值，并且组合的值不能重复；
- mysql 的主键名总是 `PRIMARY`，就算自己命名了组件约束名也不生效；
- 当创建主键约束时，系统默认会在所在的 列 或者 组合列 上建立对应的 主键索引。如果删除了主键约束了，主键约束对应的索引就自动删除了；
- 需要注意的时，不要修改主键字段的值，因为主键是数据记录的唯一标识，如果修改了主键值，有可能破坏数据的完整新;


## 添加主键约束

> 创建表时指定主键

```sql
create table 表名 (
    字段名1 字段类型 primary key,   # 列级模式
    字段名2 字段类型,
    字段名3 字段类型
)

create table 表名 (
    字段名1 字段类型,
    字段名2 字段类型,
    字段名3 字段类型,

    [constraint 约束名] primary key(字段名1) # 表级模式
)


create table 表名 (
    字段名1 字段类型,
    字段名2 字段类型,
    字段名3 字段类型,

    [constraint 约束名] primary key(字段名1， 字段名2) # 表级模式，复合主键
)
```











